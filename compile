#!/bin/bash

#VERSIONS OF LIBS
	NGINX_V=1.5.10
	OPENSSL_V=1.0.2-stable-SNAP-20140224 #ftp://ftp.openssl.org/snapshot/openssl-1.0.2-stable-SNAP-20140224.tar.gz
	ZLIB_V=1.2.8 #http://zlib.net/zlib-1.2.8.tar.gz
	PCRE_V=8.34 #ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.34.tar.gz

#DIRS
	BASEDIR=$(cd "$(dirname "$0")"; pwd)
	TMPDIR=$BASEDIR/tmp
	mkdir -p $TMPDIR

#Download packages
	cd $TMPDIR
	curl ftp://ftp.openssl.org/snapshot/openssl-$OPENSSL_V.tar.gz -o openssl.tar.gz
	curl http://zlib.net/zlib-$ZLIB_V.tar.gz -o zlib.tar.gz
	curl ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-$PCRE_V.tar.gz -o pcre.tar.gz
	curl http://nginx.org/download/nginx-$NGINX_V.tar.gz -o nginx.tar.gz

#Unpack libs
	tar zxf ./openssl.tar.gz
	tar zxf ./zlib.tar.gz
	tar zxf ./pcre.tar.gz
	tar zxf ./nginx.tar.gz

#Installing nginx with libs
	cd ./nginx-$NGINX_V
	# Configure and make
	CFG_PATH="--sbin-path=bin/ --conf-path=conf/nginx.conf --error-log-path=logs/error.log --http-client-body-temp-path=../tmp/client_body_temp/ --http-proxy-temp-path=../tmp/proxy_temp/ --http-fastcgi-temp-path=../tmp/fastcgi_temp/ --http-uwsgi-temp-path=../tmp/uwsgi_temp/ --http-scgi-temp-path=../tmp/scgi_temp/"
	CFG_ADDLIBS="--with-pcre=../pcre-$PCRE_V --with-zlib=../zlib-$ZLIB_V --with-openssl=../openssl-$OPENSSL_V"
	CFG_MODULES="--with-ipv6 --with-http_ssl_module --with-http_gzip_static_module --with-http_stub_status_module --without-mail_pop3_module --without-mail_imap_module --without-mail_smtp_module --without-http_fastcgi_module"
	./configure --prefix=. $CFG_PATH $CFG_ADDLIBS $CFG_MODULES

	make

	# Move bin file into appropriate dir
	if [ ! -d $BASEDIR/nginx/bin/ ]; then
		mkdir $BASEDIR/nginx/bin
	fi

	cp -f objs/nginx $BASEDIR/nginx/bin/

	cd $BASEDIR

	# Remove the temporary directory
	rm -r $TMPDIR/nginx-$NGINX_V && rm -r $TMPDIR/nginx.tar.gz
	rm -r $TMPDIR/openssl-$OPENSSL_V && rm -r $TMPDIR/openssl.tar.gz
	rm -r $TMPDIR/zlib-$ZLIB_V && rm -r $TMPDIR/zlib.tar.gz
	rm -r $TMPDIR/pcre-$PCRE_V && rm -r $TMPDIR/pcre.tar.gz
